{"version":3,"sources":["../src/define.ts"],"names":[],"mappings":"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","file":"define.js","sourcesContent":["import type { PluginHelper, Render } from \"@jsergo/mdit\";\nimport \"@mdit-vue/plugin-sfc\";\nimport { mapEntries } from \"@wycatsjs/utils\";\nimport parseFence from \"fenceparser\";\nimport Token from \"markdown-it/lib/token.js\";\nimport {\n  El,\n  HTML,\n  HtmlEl,\n  If,\n  InlineHtml,\n  type LazyChildren,\n} from \"./nodes.js\";\nimport {\n  MarkdownElement,\n  ParagraphElement,\n  text,\n  type LazyChild,\n  CustomBuiltin,\n  BasicFragment,\n  type Children,\n  type TextLike,\n} from \"./tokens.js\";\n\ntype OBJECT = ReturnType<typeof parseFence>;\ntype VALUE = OBJECT[keyof OBJECT];\nexport const CUSTOM_EL = \"CustomBlock\";\n\ninterface RenderOptions {\n  kind: string;\n  /**\n   * false means \"leave out the title\"\n   * undefined means \"use the default title\"\n   */\n  title: Title;\n  attrs: Record<string, VALUE>;\n  content: UnparsedContent | undefined;\n  md: PluginHelper;\n}\n\nexport class UnparsedContent implements LazyChild {\n  static of(content: string | undefined): UnparsedContent {\n    return new UnparsedContent(content);\n  }\n\n  readonly #content: string | undefined;\n\n  private constructor(content: string | undefined) {\n    this.#content = content;\n  }\n\n  get raw(): string | undefined {\n    return this.#content;\n  }\n\n  render(tokens: MarkdownElement): MarkdownElement {\n    if (this.#content) {\n      return tokens.blockHtml(this.#content);\n    }\n    return tokens;\n  }\n}\n\ntype RenderContainer = ({\n  title,\n  kind,\n  attrs,\n  content,\n  md,\n  define,\n}: {\n  title: Title;\n  kind: string;\n  attrs: Record<string, VALUE>;\n  content: UnparsedContent | undefined;\n  md: PluginHelper;\n  define: CustomBuiltin;\n}) => LazyChildren;\n\ntype BuiltinConfig =\n  | {\n      defaultTitle?: string | null | undefined;\n      color: string;\n    }\n  | CustomConfig;\n\n/**\n * A bare string is the default title.\n */\ntype BasicConfig =\n  | {\n      defaultTitle?: string | null | undefined;\n      color?: string;\n    }\n  | string;\n\nconst DEFAULT_COLOR = \"theme\";\n\nfunction ToBuiltinConfig(\n  config: BasicConfig | undefined\n): BuiltinConfig {\n  if (config === undefined || typeof config === \"string\") {\n    return {\n      defaultTitle: config ?? null,\n      color: DEFAULT_COLOR,\n    };\n  } else {\n    return {\n      color: \"theme\",\n      ...config,\n    };\n  }\n}\n\ninterface CustomConfig {\n  render: RenderContainer;\n  options?: {} | undefined;\n}\n\nclass Builtin {\n  readonly #config: BuiltinConfig;\n\n  constructor(config: BuiltinConfig) {\n    this.#config = config;\n  }\n\n  render(options: RenderOptions): Token[] {\n    const result = this.#renderFn({\n      ...options,\n      define: new CustomBuiltin(options.md),\n    });\n\n    const fragment = BasicFragment.empty(options.md);\n\n    if (Array.isArray(result)) {\n      fragment.push(...result);\n    } else {\n      fragment.push(result);\n    }\n\n    return fragment.done();\n  }\n\n  get #renderFn(): RenderContainer {\n    if (\n      typeof this.#config === \"object\" &&\n      \"render\" in this.#config\n    ) {\n      return this.#config.render;\n    }\n\n    const color = this.#config.color;\n\n    return ({ kind, title: providedTitle, content }) => {\n      const title = providedTitle.withDefault(\n        this.#defaultTitle ?? undefined\n      );\n\n      return CustomEl(\n        kind,\n        {\n          color: color ?? DEFAULT_COLOR,\n        },\n        [\n          title.map((t) =>\n            El(\"p\", { class: \"custom-block-title\" }, [t])\n          ),\n          content,\n        ]\n      );\n    };\n  }\n\n  get #defaultTitle(): string | void {\n    if (\n      typeof this.#config === \"object\" &&\n      \"defaultTitle\" in this.#config &&\n      typeof this.#config.defaultTitle === \"string\"\n    ) {\n      return this.#config.defaultTitle;\n    }\n  }\n}\n\nexport class Title implements LazyChild, TextLike {\n  static provided(provided: string | false | undefined): Title {\n    return new Title(provided, undefined);\n  }\n\n  static create(\n    provided: string | false | undefined,\n    defaultValue: string | undefined\n  ): Title {\n    return new Title(provided, defaultValue);\n  }\n\n  readonly #provided: string | undefined | false;\n  readonly #default: string | undefined;\n\n  private constructor(\n    provided: string | false | undefined,\n    defaultValue: string | undefined\n  ) {\n    this.#provided = provided;\n    this.#default = defaultValue;\n  }\n\n  [Symbol.for(\"nodejs.util.inspect.custom\")]() {\n    return `Title(${JSON.stringify(String(this))})`;\n  }\n\n  withDefault(defaultValue: string | undefined): Title {\n    return new Title(this.#provided, defaultValue);\n  }\n\n  render(tokens: MarkdownElement): MarkdownElement {\n    return tokens.append(InlineHtml(this));\n  }\n\n  isBlank(): boolean {\n    return this.#provided === false;\n  }\n\n  map<T>(callback: (title: string) => T): T | null {\n    const title = String(this);\n\n    if (title === \"\") {\n      return null;\n    } else {\n      return callback(title);\n    }\n  }\n\n  exists(): boolean {\n    if (this.#provided === false) {\n      return false;\n    } else if (this.#provided === undefined) {\n      return this.#default !== undefined;\n    } else {\n      return true;\n    }\n  }\n\n  get provided(): string | undefined | false {\n    return this.#provided;\n  }\n\n  stringify(): string {\n    if (this.#provided === false) {\n      return \"\";\n    } else if (this.#provided === undefined) {\n      return this.#default ?? \"\";\n    } else {\n      return this.#provided;\n    }\n  }\n\n  toString(): string {\n    return this.stringify();\n  }\n}\n\nexport class Builtins<N extends string> {\n  static empty(): Builtins<never> {\n    return new Builtins({});\n  }\n\n  static from<N extends string>(\n    config: Record<N, BuiltinConfig>\n  ) {\n    return new Builtins(\n      mapEntries(config, (config, name) => [\n        name,\n        new Builtin(config),\n      ])\n    );\n  }\n\n  readonly #builtins: Record<N, Builtin>;\n\n  constructor(builtins: Record<N, Builtin>) {\n    this.#builtins = builtins;\n  }\n\n  custom<NewName extends string>(\n    name: NewName,\n    render: RenderContainer\n  ): Builtins<N | NewName> {\n    return new Builtins({\n      ...this.#builtins,\n      [name]: new Builtin({\n        render,\n      }),\n    } as Record<N | NewName, Builtin>);\n  }\n\n  basic<NewName extends string>(\n    name: NewName,\n    config?: BasicConfig\n  ): Builtins<N | NewName> {\n    return new Builtins({\n      ...this.#builtins,\n      [name]: new Builtin(ToBuiltinConfig(config)),\n    });\n  }\n\n  tryGet(name: string): Builtin | undefined {\n    return (this.#builtins as Record<string, Builtin>)[name];\n  }\n\n  get(name: N): Builtin {\n    return this.#builtins[name];\n  }\n}\n\nexport function styles(\n  color: string,\n  otherStyles: Record<string, string> = {}\n) {\n  return encode({\n    ...namespaceStyle({\n      \"border-color\": fg(color),\n      fg: fg(color),\n      bg: bg(color, \"ultramuted\"),\n      \"accent-fg\": fg(color, \"dim\"),\n      \"accent-hover-bg\": bg(color, \"strong\"),\n      \"code-border\": fg(color, \"muted\"),\n      \"code-bg\": bg(color, \"muted\"),\n      \"code-fg\": bg(color, \"dim\"),\n    }),\n    ...otherStyles,\n  });\n}\n\nexport function namespaceStyle(styles: Record<string, string>) {\n  return Object.fromEntries(\n    Object.entries(styles).map(([k, v]) => [\n      `--sbdoc-block-${k}`,\n      `var(--sb-${v})`,\n    ])\n  );\n}\n\nexport function fg(color: string, style?: string) {\n  if (style) {\n    return `fg-${color}-${style}`;\n  } else {\n    return `fg-${color}`;\n  }\n}\n\nexport function bg(color: string, style?: string) {\n  if (style) {\n    return `bg-${color}-${style}`;\n  } else {\n    return `bg-${color}`;\n  }\n}\n\nexport function encode(\n  attrs?: Record<\n    string,\n    string | number | boolean | null | undefined\n  >\n): string {\n  if (attrs === undefined) {\n    return \"\";\n  }\n  return JSON.stringify(attrs).replace(/\\\"/g, \"'\");\n}\n\ntype BlockBorder = \"n\" | \"s\" | \"ns\" | \"\";\ntype InlineBorder = \"e\" | \"w\" | \"ew\" | \"\";\ntype Border = `${BlockBorder}${InlineBorder}`;\n\nexport function CustomEl(\n  kind: string,\n  options: {\n    color: string;\n    border?: Border;\n    style?: Record<string, string>;\n  },\n  children?: Children\n) {\n  return El(\n    CUSTOM_EL,\n    {\n      kind,\n      border: options.border ?? \"nsew\",\n      color: options.color,\n      \":style\": encode(options.style),\n    },\n    children\n  );\n}\n"]}